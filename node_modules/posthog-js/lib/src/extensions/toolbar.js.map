{"version":3,"file":"toolbar.js","sourceRoot":"","sources":["../../../src/extensions/toolbar.ts"],"names":[],"mappings":"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","sourcesContent":["import { _register_event, _try, loadScript } from '../utils'\nimport { PostHog } from '../posthog-core'\nimport { DecideResponse, ToolbarParams } from '../types'\nimport { _getHashParam } from '../utils/request-utils'\nimport { logger } from '../utils/logger'\nimport { window, document, assignableWindow } from '../utils/globals'\n\n// TRICKY: Many web frameworks will modify the route on load, potentially before posthog is initialized.\n// To get ahead of this we grab it as soon as the posthog-js is parsed\nconst STATE_FROM_WINDOW = window?.location\n    ? _getHashParam(window.location.hash, '__posthog') || _getHashParam(location.hash, 'state')\n    : null\n\nconst LOCALSTORAGE_KEY = '_postHogToolbarParams'\n\nexport class Toolbar {\n    instance: PostHog\n\n    private _toolbarScriptLoaded = false\n\n    constructor(instance: PostHog) {\n        this.instance = instance\n    }\n\n    afterDecideResponse(response: DecideResponse) {\n        const toolbarParams: ToolbarParams =\n            response['toolbarParams'] ||\n            response['editorParams'] ||\n            (response['toolbarVersion'] ? { toolbarVersion: response['toolbarVersion'] } : {})\n        if (\n            response['isAuthenticated'] &&\n            toolbarParams['toolbarVersion'] &&\n            toolbarParams['toolbarVersion'].indexOf('toolbar') === 0\n        ) {\n            this.loadToolbar({\n                ...toolbarParams,\n            })\n        }\n    }\n\n    /**\n     * To load the toolbar, we need an access token and other state. That state comes from one of three places:\n     * 1. In the URL hash params\n     * 2. From session storage under the key `toolbarParams` if the toolbar was initialized on a previous page\n     */\n    maybeLoadToolbar(\n        location: Location | undefined = undefined,\n        localStorage: Storage | undefined = undefined,\n        history: History | undefined = undefined\n    ): boolean {\n        if (!window || !document) {\n            return false\n        }\n        location = location ?? window.location\n        history = history ?? window.history\n\n        try {\n            // Before running the code we check if we can access localStorage, if not we opt-out\n            if (!localStorage) {\n                try {\n                    window.localStorage.setItem('test', 'test')\n                    window.localStorage.removeItem('test')\n                } catch (error) {\n                    return false\n                }\n\n                // If localStorage was undefined, and localStorage is supported we set the default value\n                localStorage = window?.localStorage\n            }\n\n            /**\n             * Info about the state\n             * The state is a json object\n             * 1. (Legacy) The state can be `state={}` as a urlencoded object of info. In this case\n             * 2. The state should now be found in `__posthog={}` and can be base64 encoded or urlencoded.\n             * 3. Base64 encoding is preferred and will gradually be rolled out everywhere\n             */\n\n            const stateHash =\n                STATE_FROM_WINDOW || _getHashParam(location.hash, '__posthog') || _getHashParam(location.hash, 'state')\n\n            let toolbarParams: ToolbarParams\n            const state = stateHash\n                ? _try(() => JSON.parse(atob(decodeURIComponent(stateHash)))) ||\n                  _try(() => JSON.parse(decodeURIComponent(stateHash)))\n                : null\n\n            const parseFromUrl = state && state['action'] === 'ph_authorize'\n\n            if (parseFromUrl) {\n                // happens if they are initializing the toolbar using an old snippet\n                toolbarParams = state\n                toolbarParams.source = 'url'\n\n                if (toolbarParams && Object.keys(toolbarParams).length > 0) {\n                    if (state['desiredHash']) {\n                        // hash that was in the url before the redirect\n                        location.hash = state['desiredHash']\n                    } else if (history) {\n                        history.replaceState('', document.title, location.pathname + location.search) // completely remove hash\n                    } else {\n                        location.hash = '' // clear hash (but leaves # unfortunately)\n                    }\n                }\n            } else {\n                // get credentials from localStorage from a previous initialization\n                toolbarParams = JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '{}')\n                toolbarParams.source = 'localstorage'\n\n                // delete \"add-action\" or other intent from toolbarParams, otherwise we'll have the same intent\n                // every time we open the page (e.g. you just visiting your own site an hour later)\n                delete toolbarParams.userIntent\n            }\n\n            if (toolbarParams['token'] && this.instance.config.token === toolbarParams['token']) {\n                this.loadToolbar(toolbarParams)\n                return true\n            } else {\n                return false\n            }\n        } catch (e) {\n            return false\n        }\n    }\n\n    private _callLoadToolbar(params: ToolbarParams) {\n        ;(assignableWindow['ph_load_toolbar'] || assignableWindow['ph_load_editor'])(params, this.instance)\n    }\n\n    loadToolbar(params?: ToolbarParams): boolean {\n        if (!window || (window.localStorage.getItem(LOCALSTORAGE_KEY) && this._toolbarScriptLoaded)) {\n            // The toolbar will clear the localStorage key when it's done with it. If it is present that indicates the toolbar is already open and running\n            return false\n        }\n\n        const disableToolbarMetrics =\n            this.instance.requestRouter.region === 'custom' && this.instance.config.advanced_disable_toolbar_metrics\n\n        const toolbarParams = {\n            token: this.instance.config.token,\n            ...params,\n            apiURL: this.instance.requestRouter.endpointFor('ui'),\n            ...(disableToolbarMetrics ? { instrument: false } : {}),\n        }\n        window.localStorage.setItem(\n            LOCALSTORAGE_KEY,\n            JSON.stringify({\n                ...toolbarParams,\n                source: undefined,\n            })\n        )\n\n        if (this._toolbarScriptLoaded) {\n            this._callLoadToolbar(toolbarParams)\n        } else {\n            // only load the toolbar once, even if there are multiple instances of PostHogLib\n            this._toolbarScriptLoaded = true\n\n            // toolbar.js is served from the PostHog CDN, this has a TTL of 24 hours.\n            // the toolbar asset includes a rotating \"token\" that is valid for 5 minutes.\n            const fiveMinutesInMillis = 5 * 60 * 1000\n            // this ensures that we bust the cache periodically\n            const timestampToNearestFiveMinutes = Math.floor(Date.now() / fiveMinutesInMillis) * fiveMinutesInMillis\n            const toolbarUrl = this.instance.requestRouter.endpointFor(\n                'assets',\n                `/static/toolbar.js?t=${timestampToNearestFiveMinutes}`\n            )\n\n            loadScript(toolbarUrl, (err) => {\n                if (err) {\n                    logger.error('Failed to load toolbar', err)\n                    this._toolbarScriptLoaded = false\n                    return\n                }\n                this._callLoadToolbar(toolbarParams)\n            })\n\n            // Turbolinks doesn't fire an onload event but does replace the entire body, including the toolbar.\n            // Thus, we ensure the toolbar is only loaded inside the body, and then reloaded on turbolinks:load.\n            _register_event(window, 'turbolinks:load', () => {\n                this._toolbarScriptLoaded = false\n                this.loadToolbar(toolbarParams)\n            })\n        }\n\n        return true\n    }\n\n    /** @deprecated Use \"loadToolbar\" instead. */\n    _loadEditor(params: ToolbarParams): boolean {\n        return this.loadToolbar(params)\n    }\n\n    /** @deprecated Use \"maybeLoadToolbar\" instead. */\n    maybeLoadEditor(\n        location: Location | undefined = undefined,\n        localStorage: Storage | undefined = undefined,\n        history: History | undefined = undefined\n    ): boolean {\n        return this.maybeLoadToolbar(location, localStorage, history)\n    }\n}\n"]}